# Output Guidelines

## Directory for analysis results
- **All analysis results (logs, CSVs, reports, etc.) must be written to `results/`.**
- The setup script (`setup.sh`) ensures this directory exists (`mkdir -p results`).
- Do **not** write result files elsewhere unless explicitly instructed.
- Unless otherwise directed, save any files generated by code to `results/` and commit them in your PR.
- Avoid overwriting existing files in `results/`; if a file already exists, append `_1`, `_2`, etc., to the filename.

## Directory for datasets
- Store all dataset files in the `data/` directory.
- The setup script (`setup.sh`) creates this directory (`mkdir -p data`).

# 👉 Overwrite & commit policy
- If a script updates an existing file in `data/`, **stage & commit the new
  version** on the same branch before opening / updating the PR.  Leaving the
  old snapshot in `main` defeats reproducibility.

## Verification
- At the end of each task, verify that the expected output files are present in `results/`.

### Commit policy for generated files
- If the analysis produces *any* new or updated files under `data/` or `results/`,
  **commit them on the same branch before opening / updating the PR**.
- Submitting only log files (or no files) is considered an incomplete task.

# Output Guidelines
- **すべての解析結果ファイルは `results/` に書き出すこと。**
- 指示がない限り、コードで生成されたファイルは `results/` に保存して PR に含めること。
- 同名ファイルが存在する場合は `_1`, `_2` など連番を付けて上書きを避ける。
- `setup.sh` が `results/` を必ず作成する。

## データセット格納場所
- データファイルは `data/` ディレクトリに置くこと。
- `setup.sh` が `data/` を作成する。

# Analysis Execution Rules
1. 解析は **Python スクリプト (`*.py`)** から実行する。
2. R を使いたい場合は、Python から次のいずれかの方法で呼び出す。
   - **`subprocess` 経由で `Rscript` を実行する**
     ```python
     import subprocess, pathlib, datetime, sys
      out_file = pathlib.Path("results") / f"summary_{datetime.datetime.now():%Y%m%d_%H%M%S}.csv"
     subprocess.run(
         ["Rscript", "src/analysis/my_analysis.R", str(out_file)],
         check=True,
     )
     ```
   - **`rpy2` を用いて R コードをインラインで実行する**
     ```python
     from rpy2 import robjects
     robjects.r('''
       library(tidyverse)
       # …R の処理…
       write.csv(result, "results/inline_result.csv", row.names = FALSE)
     ''')
     ```
3. **`.R` ファイルを Codex に直接実行させるワークフローは禁止**。
   必ず Python がハブとなり、結果ファイルを `results/` に配置すること。

## Encoding Rules
- コメント以外のコード行では **全角文字を使用しない**（変数名・文字列リテラル含む）。
  - UI 文字列など日本語が必要な場合は *必ず* `# noqa: UTF-8` 付きの
    文字列定数に切り出す。
4. 解析終了後、期待するファイルが `results/` に生成されているか確認し、存在しなければタスクを失敗扱いとする。

# Verification
- テストや self-check の際は `results/` 内のファイル数や名前を確認して合否判定を行う。

# Error Handling & Diagnostics
When any step of the analysis fails (non-zero exit status, exceptions, or missing output in `results/`):

1. **Capture details**
   - Save `stdout`/`stderr` logs to `results/error_<timestamp>.log`.
   - Record the exact exit code and failing command or stack trace.

2. **Identify root cause**
   - Parse the log and classify the failure (e.g., missing package, path error, R script crash, permission issue).
   - Search the repository for relevant files or configuration that may be involved.

3. **Propose a fix**
   - Add a plaintext file `results/fix_<timestamp>.txt` that briefly explains
     - *What failed* (one sentence)
     - *Why it failed* (evidence or hypothesis)
     - *How to fix* (concrete steps or code snippet)
   - Keep the explanation under 30 lines. Use bullet points.

4. **Report in task output**
   - If running in Ask-mode, include a summary of the above in the final ChatGPT response.
   - If running in Code-mode (PR), include the same summary in the PR description under a section titled `### Failure Analysis`.

5. **Do not silently ignore errors**. A task is “done” only when either
   - the analysis succeeds and `results/` contains the expected files, **or**
   - an error report *and* proposed fix have been produced as described above.

6. **Re-run policy**
   - After applying a proposed fix, re-run the failing step automatically once.
   - If it still fails, update the error report with the new findings instead of looping indefinitely.
7. **Missing dependencies during tests**
   - If a test fails because a required Python module is missing, append that module's name to `requirements.txt` and run the tests again.


## Execution Logging
- `notebooks_build/` は Git 管理しない（.gitignore 済み）。

### Notebook Generation
- `make notebook` は `analysis_steps/*.py` を番号順に読み込み、各スクリプトを 1 セルとしてまとめた Notebook `notebooks_build/execution_log.ipynb` を生成する。
- セル構成:
  1. Markdown 見出し 「001 – Summarize Dataset」
  2. 対応スクリプト全文の Code セル
  （ログや標準出力は Notebook には含めない）
- 追加パッケージ不要。標準ライブラリのみで完結。

## Script Placement & Naming
1. 解析用 Python スクリプトは **すべて `analysis_steps/`** に置く。
2. ファイル名は `NNN_<slug>.py` とし、`NNN` は 001 から順にインクリメント。
3. 既存番号をスキップしない。新規スクリプトを追加する際は
   リポジトリを走査して **最大番号+1** を採番すること。
4. `<slug>` は処理内容を示す英小文字＋アンダースコア。20 文字以内。
5. スクリプト実行時は  
   ```bash
    python analysis_steps/NNN_<slug>.py
   ```
## Claude Code 設定ファイルの階層と責務

### 1. `.github/workflows/claude.yml` ― GitHub Actions の“外側”設定
- **目的**  
  - 「いつ」「どのイベントで」Claude Code Action を起動するかを定義する。
  - 実行環境（ランナー OS・Python バージョン）、トークン類（API Key / GITHUB_TOKEN）を注入する。
  - 依存ライブラリのインストールや concurrency 制御など、CI 的な前後処理を行う。
- **手を入れるタイミング**  
  - Action のバージョンを更新するとき（例: `@v1` → `@v2`）。  
  - 新しいランタイムや追加パッケージが必要になったとき。  
  - トリガーやタイムアウトなど、CI レベルの条件を変えたいとき。

### 2. `.claude/claude.yml` ― Claude セッションの“内側”設定
- **目的**  
  - Claude への system_prompt（禁止・推奨ディレクトリ、ファイル保存ルールなど）を常時読み込ませる。  
  - `allowed_tools` で Bash や Edit など **実行可能コマンドのホワイトリスト** を決める。  
  - 1 タスクあたりの `timeout_minutes` や Claude 内部の `concurrency` を設定する。
- **手を入れるタイミング**  
  - 新しい社内ルール（例: 解析結果は必ず `results/` へ）が増えたとき。  
  - 使いたい Bash コマンドが増えた／減ったとき。  
  - Claude の応答テンプレートや自己チェック規約を更新したいとき。

### 3. ベストプラクティス
- **allowed_tools は `.claude/claude.yml` に一本化**  
  ワークフロー側で重複指定すると、セッションへ反映されない場合があるため。  
- **ブランチ名は ASCII (a-z, 0-9, `-`, `_`) のみ使用する**  
  GitHub UI での表示バグや一部ツールのパースエラーを防ぐ。
- **ワークフロー側では `config_file: .claude/claude.yml` だけ指定**  
  Claude Action に「内側設定をここから読んでね」と渡すだけに留める。  
- **Action バージョンは固定タグで管理**  
  例: `anthropics/claude-code-action@v1`  
  `@main` や `@beta` は Breaking Change を即時拾うリスクがある。  

### 4. 変更フロー例
1. `.claude/claude.yml` に `allowed_tools: ["Bash(*)","Edit"]` を追加。  
2. ワークフローの `Run Claude Code` ステップを安定版タグへ更新。  
3. CI が通ることを確認し、`fix/claude-config` ブランチで PR 作成。  
4. レビュー後に main へマージ。  

> **Tip:**  
> `.claude/claude.yml` は **ローカル CLI からの呼び出し** にも自動で適用されるため、  
> 開発者の手元と CI 環境で設定が食い違う心配がありません。

## Generated artefacts

```codex-policy
allow_overwrite:
  - path: data/**/*.csv
    max_size_mb: 20
```
